{% extends 'base/base.html' %} 
{% load staticfiles %} 

{% block title %} {{ FEST_NAME }} {% endblock %} 

{% block content %}
    <div class="row-fluid">
        <div class="span12">
            <h4>Docs <small class="drive_parent_title"></small></h4>
        </div>
    </div>

    <div class="row-fluid drive_bar">
        <div class="span12">
            <a class="btn drive_back"> <i class="icon-left"></i> </a>
            <a class="btn drive_refresh"> 
                <i class="icon-refresh"></i>
            </a>
            &nbsp;&nbsp;&nbsp;&nbsp;
            <a class="btn primary drive_upload"> 
                <i class="icon-upload"></i>  <span class="text">Upload </span>
            </a>
            
            <a class="btn primary drive_create" onclick="alert('Not done yet');"> 
                <i class="icon-plus"></i> <span class="text">Create </span>
            </a>
            <a class="btn primary drive_share" onclick="alert('Not done yet');"> 
                <i class="icon-share"></i> <span class="text">Share </span>
            </a>
            <a class="btn primary drive_move">
                <i class="icon-folder"></i> <span class="text">Move </span>
            </a>
        
			&nbsp;
            <div class="pull-right">
                <a class="btn primary drive_delete"> 
                    <i class="icon-trash"></i> <span class="text">Delete </span>
                </a>
            </div>
        </div>
    </div>
    <div class="row-fluid">
    	<div class="span1">
    		<div class="progress_val"></div>
    	</div>
    	<div class="span11">
    		<div class="meter">
				<span class="progress" style="width: 0%">
					
				</span>
			</div>
    	</div>
    </div>
    <div class="row-fluid drive_list">
        <div class="span12">
            <table class="zebra-striped table drive_parent" {% if request.GET.id %}data-id="{{request.GET.id}}"{% endif %} cellpadding="0" cellspacing="0">
                <tr class="head">
                    <th class="checkbox"> 
                        <div class="drive_checkbox"> 
                            <div class="border"></div> 
                        </div>
                    </th>
                    <th class="title"> TITLE </th>
                    <th class="last_modified"> LAST MODIFIED </th>
                </tr>
                <tr class="drive_file template file_template" style="display : none;">
                    <td class="checkbox">
                        <div class="drive_checkbox">
                            <div class="border"></div>
                        </div>
                    </td>
                    <td class="info">
                        <a href="{%url 'view' %}" target="_blank">
                            <img class="drive_icon" src="" />
                            <span class="title"></span>
                        </a>
                    </td>
                    <td class="last_modified"></td>
                </tr>
            </table>
        </div>
    </div>
    

<input id="drive_upload_chooser" type="file" style='display:none'></input>

<!--<div id='sharebox' data-fileid='' style="top:50%; position:absolute; width:100%; text-align:center; display:none; background-color: rgb(59, 89, 152); z-index:3" class="popover">
    <div id="inner" style="margin-top: 20px; margin-bottom: 20px; margin-left: 9px; margin-right: 10px;">
        <h1 style='color:white;font-weight:bolder'>Share File</h1>
        <select id='select0' class="select2 select_all_list" multiple>

        </select>

        <button id="share" class="fa fa-share fa-2x" style='background:none;margin-left:10px' onclick="shareFileMultiple($('#sharebox').attr('data-fileid'),$('#select0').val());"></button>
        <button id="close" class="fa fa-undo fa-2x" style='background:none;margin-left:10px' onclick="$('#sharebox').css('display','none')"></button>
    </div>
</div>
-->
{% endblock %} 

{% block extra_css %} {{ block.super }}
<style>
    .drive_file .drive_icon {
        margin : 2px;
        display : inline-block;
        float : left;
    }
    .drive_file .info .title {
        line-height : 20px;
        height : 100%;
        display : inline-block;
    }
    .drive_file .drive_checkbox {
        width : 16px;
        height : 16px;
        z-index : 2;
    }
    .drive_file .drive_checkbox .border {
        width : 10px;
        height : 10px;
        margin : 2px;
        border-radius : 3px;
        border : 1px solid #aaa;
        z-index : 1;
    }
    .drive_file .drive_checkbox:hover .border {
        border : 1px solid #000;
    }
    tr.drive_file.select {
        border-left : 3px solid transparent;
    }
    .zebra-striped tbody tr.drive_file.select:hover td, 
    .zebra-striped tbody tr.drive_file.select:hover th,
    .zebra-striped tbody tr.drive_file.select td, 
    .zebra-striped tbody tr.drive_file.select th,
    tr.drive_file.select, tr.drive_file.select:hover {
        background-color : rgb(255, 255, 204);
    }
    tr.drive_file.select, tr.drive_file.select:hover {
        border-left : 3px solid rgb(50, 50, 255);
    }

    /* ------------- PROGRESS BAR ------------- */
	.meter { 
		height: 15px;  /* Can be anything */
		position: relative;
		background: #fff;
		border : 1px solid blue;
		margin : 5px;
		-moz-border-radius: 25px;
		-webkit-border-radius: 25px;
		border-radius: 25px;
		padding: 2px;
		-webkit-box-shadow: inset 0 -1px 1px rgba(255,255,255,0.3);
		-moz-box-shadow   : inset 0 -1px 1px rgba(255,255,255,0.3);
		box-shadow        : inset 0 -1px 1px rgba(255,255,255,0.3);
	}
	.meter > span {
		line-height : 15px;
		font-size : 10px;
		font-weight : bold;
		color : white;
		display: block;
		height: 100%;
		   -webkit-border-top-right-radius: 8px;
		-webkit-border-bottom-right-radius: 8px;
		       -moz-border-radius-topright: 8px;
		    -moz-border-radius-bottomright: 8px;
		           border-top-right-radius: 8px;
		        border-bottom-right-radius: 8px;
		    -webkit-border-top-left-radius: 20px;
		 -webkit-border-bottom-left-radius: 20px;
		        -moz-border-radius-topleft: 20px;
		     -moz-border-radius-bottomleft: 20px;
		            border-top-left-radius: 20px;
		         border-bottom-left-radius: 20px;
		background-color: #3b5998;
		background-image: -moz-linear-gradient(top, #3d390a, #3b5998);
		background-image: -webkit-linear-gradient(#3d390a, #3b5998); 
		-webkit-box-shadow: 
		  inset 0 2px 9px  rgba(255,255,255,0.3),
		  inset 0 -2px 6px rgba(0,0,0,0.4);
		-moz-box-shadow: 
		  inset 0 2px 9px  rgba(255,255,255,0.3),
		  inset 0 -2px 6px rgba(0,0,0,0.4);
		box-shadow: 
		  inset 0 2px 9px  rgba(255,255,255,0.3),
		  inset 0 -2px 6px rgba(0,0,0,0.4);
		position: relative;
		overflow: hidden;
	}
	.meter > span:after, .animate > span > span {
		content: "";
		position: absolute;
		top: 0; left: 0; bottom: 0; right: 0;
		background-image: 
		   -webkit-gradient(linear, 0 0, 100% 100%, 
		      color-stop(.25, rgba(255, 255, 255, .2)), 
		      color-stop(.25, transparent), color-stop(.5, transparent), 
		      color-stop(.5, rgba(255, 255, 255, .2)), 
		      color-stop(.75, rgba(255, 255, 255, .2)), 
		      color-stop(.75, transparent), to(transparent)
		   );
		background-image: 
			-moz-linear-gradient(
			  -45deg, 
		      rgba(255, 255, 255, .2) 25%, 
		      transparent 25%, 
		      transparent 50%, 
		      rgba(255, 255, 255, .2) 50%, 
		      rgba(255, 255, 255, .2) 75%, 
		      transparent 75%, 
		      transparent
		   );
		z-index: 1;
		-webkit-background-size: 50px 50px;
		-moz-background-size: 50px 50px;
		   -webkit-border-top-right-radius: 8px;
		-webkit-border-bottom-right-radius: 8px;
		       -moz-border-radius-topright: 8px;
		    -moz-border-radius-bottomright: 8px;
		           border-top-right-radius: 8px;
		        border-bottom-right-radius: 8px;
		    -webkit-border-top-left-radius: 20px;
		 -webkit-border-bottom-left-radius: 20px;
		        -moz-border-radius-topleft: 20px;
		     -moz-border-radius-bottomleft: 20px;
		            border-top-left-radius: 20px;
		         border-bottom-left-radius: 20px;
		overflow: hidden;
	}

 	.animate > span > span {
 		webkit-animation: move 2s linear infinite;
 	}
		
	.animate > span:after {
		display: none;
	}

	@-webkit-keyframes move {
	    0% {
	       background-position: 0 0;
	    }
	    100% {
	       background-position: 50px 50px;
	    }
	}
	.progress_val{
		font-weight : bold;
		line-height : 25px;
		font-size : 11px;
		padding: 2px;
		
	}
</style>
{% endblock %} 

{% block extra_js %} {{ block.super }}
<script type="text/javascript">
var developerKey = '{{ SETTINGS.GOOGLE_API_PUBLIC_KEY }}';
var rootFolder = '{{ SETTINGS.GOOGLE_DRIVE_ROOT_FOLDER_ID }}';
var authToken = '{{ token }}';

var allFiles = null;

var heirarchy = [];
var MIME_DIRECTORY = 'application/vnd.google-apps.folder'
// view function.
drive = null;

$(document).ready(function() {
    console.log("Ready")
    // $('.select2').select2();
    
});

function drive_callback() {
    drive = new Drive({
        "authToken": authToken,
        "developerKey": developerKey,
        "rootFolder": rootFolder,
    })
    init_button_bar ()

}

function init_button_bar() {
    $(".drive_back").click(function(e) {
        $(this).prop("disabled", true).addClass("disabled")
        drive.show_parent($(".drive_parent").data("id"))
    })
    $(".drive_refresh").click(function(e) {
        $(this).prop("disabled", true).addClass("disabled")
        drive.get_dir_contents($(".drive_parent").data("id"))
    })
    
	$(".drive_upload").click( function (e) {
        $("#drive_upload_chooser").click() 
    });
    $(".drive_move").click( function (e) {
        gapi.load('picker', { 'callback': move_picker });
    });
    
    $(".drive_delete").click(function(e) {
        $(this).prop("disabled", true).addClass("disabled")
        drive.delete_files(
            $.map($(".drive_parent .drive_file.select"), function(val, i) { 
                return { "id" : $(val).data("id") } 
            }), function() {
            	$(".drive_delete").prop("disabled", false).removeClass("disabled")
            	drive.get_dir_contents()
            }
        )
    })
    $('#drive_upload_chooser').change(upload_file);
}

function upload_file(e) {
    $(".drive_upload").prop("disabled", true).addClass("disabled").find(".text").text("Uploading...")
    drive.upload_file(e.target.files[0], $(".drive_parent").data("id"), function() {
        $(".drive_upload").prop("disabled", false).removeClass("disabled").find(".text").text("Upload")
        drive.get_dir_contents()
    })
}



function move_picker() {
    var folderView = new google.picker.DocsView(google.picker.ViewId.FOLDERS)
        .setIncludeFolders(true)
        //.setParent(drive.options.rootFolder)
        .setSelectFolderEnabled(true);
        //.setOwnedByMe(false)

    var picker = new google.picker.PickerBuilder()
        .setOAuthToken(authToken)
        .addView(folderView)
        //.enableFeature(google.picker.Feature.MULTISELECT_ENABLED)
        .enableFeature(google.picker.Feature.NAV_HIDDEN)
        .setCallback(move_picker_done)
        .build();

    picker.setVisible(true);
}

function move_picker_done(data) {
    console.log(data)
    f = data
    if (data.action == google.picker.Action.PICKED) {
        folder = data.docs[0];
        if ( folder.mimeType != MIME_TYPES["folder"] ) {
        	console.log("Woah there : You did not select a folder")
        	alert("Woah there : You did not select a folder")
        	return
        } else {
        	drive.move_files($.map($(".drive_parent .drive_file.select"), function(val, i) { 
                return { "id" : $(val).data("id"),
                	"old_parent_id": $(".drive_parent").data("id"),
                	"new_parent_id": folder.id,
                } 
            }))
        }
    }
}









function uploadFile(evt) {
    // alert(JSON.stringify(evt.target.files[0]));
    insertFile(evt.target.files[0], currFolder, function() {
        alert("successful");
    });
}

function getDirectoryContents(all_files, dir_id) {
    console.log("Get dir contents")
    dir_files = []
    all_files.forEach(function(item) {
        if (item.parents[0].id == dir_id)
            dir_files.push(item);
    });
    return dir_files;
}

function newFolder(name, dir_id) {
    uploadEmptyFolder(name, dir_id, function() {
        getFiles(showAllFiles);
    });
}

function renameFile(name, fileid) {
    renameFile(fileid, name, function() {
        getFiles(showAllFiles);
    });
}

function share(fileid, dest_email, access) {
    shareFile(fileid, dest_email, 'writer', function() {
        getFiles(showAllFiles);
    });
}
// view function.

function toHTML(file) {
    var html = '';
    //alert(JSON.stringify(file));

    file_type = ''
    if (file.mimeType)
        file_type = file.mimeType;


    // calculate the file's download url.
    d_url = '#'; // initialize the url
    if (file.webContentLink) // for normal files, use webContentLink
        d_url = file.webContentLink;
    else if (file.exportLinks) // for google doc files, use exportLinks
        d_url = file.exportLinks[Object.keys(file.exportLinks)[0]];
    // if none exists the file is a directory. leave it.

    if (file_type != MIME_DIRECTORY)
        html += '<a href="#"><div class="span4 fileview" style="text-align:center;margin-top:15px;margin-left:10px"><img src="' + file.thumbnailLink + '" class="thumbnail"><div><img src="' + file.iconLink + '"><h6>' + file.title + '</h6></div><div style="text-align:center;display:inline-flex;padding-top:5px;"><button class="fa fa-cloud-download fa-lg driveicon" onclick="window.location=\'' + d_url + '\'"></button><button class="fa fa-share fa-lg driveicon" onclick=\'$("#sharebox").css("display","inline").attr("data-fileid","' + file.id + '")\'></button><button class="fa fa-eye fa-lg driveicon" onclick="window.location=\'{%url "view" %}?docurl=' + file.id + '\'"></button><button class="fa fa-trash-o fa-lg driveicon" onclick=\'deleteFile("' + file.id + '");\'></button><button class="fa fa-edit fa-lg driveicon" onclick="$(\'#renamebox\').css(\'display\',\'inline\').attr(\'data-fileid\',\'' + file.id + '\')"></button></div></div></a>';
    else
        html += '<a href="#"><div class="span4 col-md-3 fileview" style="text-align:center;margin-top:15px;margin-left:10px"><div style="width:100%;height:160px;text-align:center"><button class="fa fa-folder fa-4x"  onclick="showDirectoryContents(\'' + file.id + '\',true);" style="margin-top:80px;background-color:#FFF"></button></div><img src="' + file.iconLink + '"><h6 onclick="showDirectoryContents(\'' + file.id + '\',true);">' + file.title + '</h6><div style="text-align:center;display:inline-flex;padding-top:5px;"><button class="fa fa-trash-o fa-lg driveicon" onclick=\'deleteFile("' + file.id + '");\'></button><button class="fa fa-edit fa-lg driveicon" onclick="$(\'#renamebox\').css(\'display\',\'inline\').attr(\'data-fileid\',\'' + file.id + '\')"></button></div></div></a>';
    return html;
}

function addUploadTile() {
    html = "";
    html += '<button class="span4 fileview" onclick="$(\'#filechooser\').click();" style="text-align:center;margin-top:15px;margin-left:10px"><h3><b>UPLOAD</b></h3></button>';
    $('#drivebrowse_main').append(html);
}

function addFolderCreateTile(dir_id) {
    html = "";
    html += '<button class="span4 fileview" onclick="uploadEmptyFolder(\'New Folder\',\'' + dir_id + '\')" style="text-align:center;margin-top:15px;margin-left:10px"><h3><b>NEW FOLDER</b></h3></button>';
    $('#drivebrowse_main').append(html);
}

function addBackTile(dir_id) {
    html = "";
    html += '<button class="span4 fileview" onclick="showDirectoryContents(\'' + getFileObject(dir_id).parents[0].id + '\',true);" style="text-align:center;margin-top:15px;margin-left:10px"><h3><b>BACK</b></h3></button>';
    $('#drivebrowse_main').append(html);
}


function uploadEmptyFile(mimetype, name, dir_id) {
    var text = " ";
    var xhr2 = new XMLHttpRequest();
    xhr2.open('POST', 'https://content.googleapis.com/drive/v2/files?key=' + developerKey);
    xhr2.setRequestHeader('Authorization', 'Bearer ' + authToken);
    xhr2.setRequestHeader('Content-Type', 'application/json');
    xhr2.onreadystatechange = function() {
        var xhr = new XMLHttpRequest();
        xhr.open('PUT', 'https://www.googleapis.com/upload/drive/v2/files/' + JSON.parse(xhr2.responseText).id + '?uploadType=media');
        xhr.setRequestHeader('Authorization', 'Bearer ' + authToken);
        xhr.setRequestHeader('Content-Type', mimetype);
        xhr.onreadystatechange = function(res) {
            alert(JSON.stringify(res));
        }
        xhr.send(text);
    }
    xhr2.send(JSON.stringify({
        'title': name,
        'mimeType': mimetype,
        'parents': [{
            'id': dir_id,
            'kind': 'drive#parentReference'
        }]
    }));
}

function uploadEmptyFolder(name, dir_id) {
    var xhr2 = new XMLHttpRequest();
    xhr2.open('POST', 'https://content.googleapis.com/drive/v2/files?key=' + developerKey);
    xhr2.setRequestHeader('Authorization', 'Bearer ' + authToken);
    xhr2.setRequestHeader('Content-Type', 'application/json');
    xhr2.onreadystatechange = getFiles;
    xhr2.send(JSON.stringify({
        'title': name,
        'mimeType': MIME_DIRECTORY,
        'parents': [{
            'id': dir_id,
            'kind': 'drive#parentReference'
        }]
    }));
}


function shareFile(fileId, dest_email) {
    var body = {
        'value': dest_email,
        'type': 'user',
        'role': 'writer'
    };
    var request = gapi.client.drive.permissions.insert({
        'fileId': fileId,
        'resource': body
    });
    request.execute(function(resp) {
        getFiles();
    });
}

function shareFileMultiple(fileId, dest_emails) {
    alert(JSON.stringify(dest_emails));
    dest_emails.forEach(function(email) {
        shareFile(fileId, email);
    });
}
$.fn.driveOverlay = function() {
    $(this).append('<div class="drive_overlay"></div>');
    var c = $(this).children('.drive_overlay');
    var rect = $(this)[0].getClientRects()[0];
    alert(JSON.stringify(rect));
    alert(c.length);
    c.css('width', rect.width);
    c.css('height', rect.height);
    c.css('top', rect.top);
    c.css('left', rect.left);
}



</script>

<script src='{% static "js/drive.js" %}'></script>
<script src="http://www.google.com/jsapi"></script>
<script type="text/javascript" src="https://apis.google.com/js/client.js?onload=drive_callback"></script>
<script type="text/javascript" src='{% static "js/moment.js" %}'></script>

{% endblock %}
