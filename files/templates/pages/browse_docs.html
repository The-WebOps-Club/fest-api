{% extends 'base/base.html' %} 
{% load staticfiles %} 

{% block title %} {{ FEST_NAME }} {% endblock %} 

{% block content %}
    <div class="row-fluid">
        <div class="span12">
            <h4>Docs </h4>
        </div>
    </div>

    <div class="row-fluid drive_bar">
        <div class="span12">
            <a class="btn drive_back"> <i class="icon-exit"></i> Back </a>
            <a class="btn primary drive_upload"> 
                <i class="icon-upload"></i>  Upload 
            </a>
            <a class="btn primary drive_share" onclick="alert('Not done yet');"> 
                <i class="icon-share"></i> Share 
            </a>
            <a class="btn drive_refresh" onclick="alert('Not done yet');"> 
                <i class="icon-refresh"></i> Refresh
            </a>
            <div class="pull-right">
                <a class="btn primary drive_move">
                    <i class="icon-folder"></i> Move 
                </a>
                <a class="btn primary drive_delete"> 
                    <i class="icon-stop"></i> Delete 
                </a>
            </div>
        </div>
    </div>
    <div class="row-fluid drive_list">
        <div class="span12">
            <table class="zebra-striped table drive_parent" cellpadding="0" cellspacing="0">
                <tr class="head">
                    <th class="checkbox"> 
                        <div class="drive_checkbox"> 
                            <div class="border"></div> 
                        </div>
                    </th>
                    <th class="title"> TITLE </th>
                    <th class="last_modified"> LAST MODIFIED </th>
                </tr>
                <tr class="drive_file template file_template" style="display : none;">
                    <td class="checkbox">
                        <div class="drive_checkbox">
                            <div class="border"></div>
                        </div>
                    </td>
                    <td class="info">
                        <a href="{%url 'view' %}" target="_blank">
                            <img class="drive_icon" src="" />
                            <span class="title"></span>
                        </a>
                    </td>
                    <td class="last_modified"></td>
                </tr>
            </table>
        </div>
    </div>
    

<input id='filechooser' type=file style='display:none'></input>
<!--<button id='filechooser_trig' onclick='$("#filechooser").click();'>Trig</button>-->
<div id='sharebox' data-fileid='' style="top:50%; position:absolute; width:100%; text-align:center; display:none; background-color: rgb(59, 89, 152); z-index:3" class="popover">
    <div id="inner" style="margin-top: 20px; margin-bottom: 20px; margin-left: 9px; margin-right: 10px;">
        <h1 style='color:white;font-weight:bolder'>Share File</h1>
        <select id='select0' class="select2 select_all_list" multiple>

        </select>

        <button id="share" class="fa fa-share fa-2x" style='background:none;margin-left:10px' onclick="shareFileMultiple($('#sharebox').attr('data-fileid'),$('#select0').val());"></button>
        <button id="close" class="fa fa-undo fa-2x" style='background:none;margin-left:10px' onclick="$('#sharebox').css('display','none')"></button>
    </div>
</div>

<div id='renamebox' data-fileid='' style="top:50%;position:absolute;width:100%;text-align:center;display:none;background-color: rgb(59, 89, 152);z-index:4" class="popover">
    <div id="inner" style="
    margin-top: 20px;
    margin-bottom: 20px;
    margin-left: 9px;
    margin-right: 10px;
            ">
        <h1 style='color:white;font-weight:bolder'>Rename File To</h1>
        <input type=text id='rename' style='width:300px'>
        <button id="share" class="fa fa-share fa-2x" style='background:none;margin-left:10px' onclick="renameFile($('#renamebox').attr('data-fileid'),$('#rename').val());"></button>
        <button id="close" class="fa fa-undo fa-2x" style='background:none;margin-left:10px' onclick="$('#renamebox').css('display','none')"></button>
    </div>
</div>

{% endblock %} 

{% block extra_css %} {{ block.super }}
<style>
    .drive_file .drive_icon {
        margin : 2px;
        display : inline-block;
        float : left;
    }
    .drive_file .info .title {
        line-height : 20px;
        height : 100%;
        display : inline-block;
    }
    .drive_file .drive_checkbox {
        width : 16px;
        height : 16px;
        z-index : 2;
    }
    .drive_file .drive_checkbox .border {
        width : 10px;
        height : 10px;
        margin : 2px;
        border-radius : 3px;
        border : 1px solid #aaa;
        z-index : 1;
    }
    .drive_file .drive_checkbox:hover .border {
        border : 1px solid #000;
    }
    tr.drive_file.select {
        border-left : 3px solid transparent;
    }
    .zebra-striped tbody tr.drive_file.select:hover td, 
    .zebra-striped tbody tr.drive_file.select:hover th,
    .zebra-striped tbody tr.drive_file.select td, 
    .zebra-striped tbody tr.drive_file.select th,
    tr.drive_file.select, tr.drive_file.select:hover {
        background-color : rgb(255, 255, 204);
    }
    tr.drive_file.select, tr.drive_file.select:hover {
        border-left : 3px solid rgb(50, 50, 255);
    }
</style>
{% endblock %} 

{% block extra_js %} {{ block.super }}
<script type="text/javascript">
var developerKey = '{{ api_key }}';
var rootFolder = '{{ SETTINGS.GOOGLE_DRIVE_ROOT_FOLDER_ID }}';
var authToken = '{{ token }}';

var allFiles = null;

var heirarchy = [];
var MIME_DIRECTORY = 'application/vnd.google-apps.folder'
// view function.
drive = null;

$(document).ready(function() {
    console.log("Ready")
    // $('.select2').select2();
    $('#filechooser').change(uploadFile);
});

function drive_callback() {
    drive = new Drive({
        "authToken": authToken,
        "developerKey": developerKey,
        "rootFolder": rootFolder,
    })
    init_button_bar ()

}

function init_button_bar() {
    $(".drive_upload")
    $(".drive_back").click(function() {
        drive.show_parent($(".drive_parent").data("id"))
    })
    $(".drive_refresh").click(function() {
        drive.get_dir_contents($(".drive_parent").data("id"))
    })
    $(".drive_delete").click(function() {

        drive.delete_file(
                $.map($(".drive_parent .drive_file.select"), function(val, i) { return { "id" : $(val).data("id") } } )
                )
    })
}







function uploadFile(evt) {
    // alert(JSON.stringify(evt.target.files[0]));
    insertFile(evt.target.files[0], currFolder, function() {
        alert("successful");
    });
}

function getDirectoryContents(all_files, dir_id) {
    console.log("Get dir contents")
    dir_files = []
    all_files.forEach(function(item) {
        if (item.parents[0].id == dir_id)
            dir_files.push(item);
    });
    return dir_files;
}

function newFolder(name, dir_id) {
    uploadEmptyFolder(name, dir_id, function() {
        getFiles(showAllFiles);
    });
}

function renameFile(name, fileid) {
    renameFile(fileid, name, function() {
        getFiles(showAllFiles);
    });
}

function share(fileid, dest_email, access) {
    shareFile(fileid, dest_email, 'writer', function() {
        getFiles(showAllFiles);
    });
}
// view function.

function toHTML(file) {
    var html = '';
    //alert(JSON.stringify(file));

    file_type = ''
    if (file.mimeType)
        file_type = file.mimeType;


    // calculate the file's download url.
    d_url = '#'; // initialize the url
    if (file.webContentLink) // for normal files, use webContentLink
        d_url = file.webContentLink;
    else if (file.exportLinks) // for google doc files, use exportLinks
        d_url = file.exportLinks[Object.keys(file.exportLinks)[0]];
    // if none exists the file is a directory. leave it.

    if (file_type != MIME_DIRECTORY)
        html += '<a href="#"><div class="span4 fileview" style="text-align:center;margin-top:15px;margin-left:10px"><img src="' + file.thumbnailLink + '" class="thumbnail"><div><img src="' + file.iconLink + '"><h6>' + file.title + '</h6></div><div style="text-align:center;display:inline-flex;padding-top:5px;"><button class="fa fa-cloud-download fa-lg driveicon" onclick="window.location=\'' + d_url + '\'"></button><button class="fa fa-share fa-lg driveicon" onclick=\'$("#sharebox").css("display","inline").attr("data-fileid","' + file.id + '")\'></button><button class="fa fa-eye fa-lg driveicon" onclick="window.location=\'{%url "view" %}?docurl=' + file.id + '\'"></button><button class="fa fa-trash-o fa-lg driveicon" onclick=\'deleteFile("' + file.id + '");\'></button><button class="fa fa-edit fa-lg driveicon" onclick="$(\'#renamebox\').css(\'display\',\'inline\').attr(\'data-fileid\',\'' + file.id + '\')"></button></div></div></a>';
    else
        html += '<a href="#"><div class="span4 col-md-3 fileview" style="text-align:center;margin-top:15px;margin-left:10px"><div style="width:100%;height:160px;text-align:center"><button class="fa fa-folder fa-4x"  onclick="showDirectoryContents(\'' + file.id + '\',true);" style="margin-top:80px;background-color:#FFF"></button></div><img src="' + file.iconLink + '"><h6 onclick="showDirectoryContents(\'' + file.id + '\',true);">' + file.title + '</h6><div style="text-align:center;display:inline-flex;padding-top:5px;"><button class="fa fa-trash-o fa-lg driveicon" onclick=\'deleteFile("' + file.id + '");\'></button><button class="fa fa-edit fa-lg driveicon" onclick="$(\'#renamebox\').css(\'display\',\'inline\').attr(\'data-fileid\',\'' + file.id + '\')"></button></div></div></a>';
    return html;
}

function addUploadTile() {
    html = "";
    html += '<button class="span4 fileview" onclick="$(\'#filechooser\').click();" style="text-align:center;margin-top:15px;margin-left:10px"><h3><b>UPLOAD</b></h3></button>';
    $('#drivebrowse_main').append(html);
}

function addFolderCreateTile(dir_id) {
    html = "";
    html += '<button class="span4 fileview" onclick="uploadEmptyFolder(\'New Folder\',\'' + dir_id + '\')" style="text-align:center;margin-top:15px;margin-left:10px"><h3><b>NEW FOLDER</b></h3></button>';
    $('#drivebrowse_main').append(html);
}

function addBackTile(dir_id) {
    html = "";
    html += '<button class="span4 fileview" onclick="showDirectoryContents(\'' + getFileObject(dir_id).parents[0].id + '\',true);" style="text-align:center;margin-top:15px;margin-left:10px"><h3><b>BACK</b></h3></button>';
    $('#drivebrowse_main').append(html);
}


function uploadEmptyFile(mimetype, name, dir_id) {
    var text = " ";
    var xhr2 = new XMLHttpRequest();
    xhr2.open('POST', 'https://content.googleapis.com/drive/v2/files?key=' + developerKey);
    xhr2.setRequestHeader('Authorization', 'Bearer ' + authToken);
    xhr2.setRequestHeader('Content-Type', 'application/json');
    xhr2.onreadystatechange = function() {
        var xhr = new XMLHttpRequest();
        xhr.open('PUT', 'https://www.googleapis.com/upload/drive/v2/files/' + JSON.parse(xhr2.responseText).id + '?uploadType=media');
        xhr.setRequestHeader('Authorization', 'Bearer ' + authToken);
        xhr.setRequestHeader('Content-Type', mimetype);
        xhr.onreadystatechange = function(res) {
            alert(JSON.stringify(res));
        }
        xhr.send(text);
    }
    xhr2.send(JSON.stringify({
        'title': name,
        'mimeType': mimetype,
        'parents': [{
            'id': dir_id,
            'kind': 'drive#parentReference'
        }]
    }));
}

function uploadEmptyFolder(name, dir_id) {
    var xhr2 = new XMLHttpRequest();
    xhr2.open('POST', 'https://content.googleapis.com/drive/v2/files?key=' + developerKey);
    xhr2.setRequestHeader('Authorization', 'Bearer ' + authToken);
    xhr2.setRequestHeader('Content-Type', 'application/json');
    xhr2.onreadystatechange = getFiles;
    xhr2.send(JSON.stringify({
        'title': name,
        'mimeType': MIME_DIRECTORY,
        'parents': [{
            'id': dir_id,
            'kind': 'drive#parentReference'
        }]
    }));
}


function shareFile(fileId, dest_email) {
    var body = {
        'value': dest_email,
        'type': 'user',
        'role': 'writer'
    };
    var request = gapi.client.drive.permissions.insert({
        'fileId': fileId,
        'resource': body
    });
    request.execute(function(resp) {
        getFiles();
    });
}

function shareFileMultiple(fileId, dest_emails) {
    alert(JSON.stringify(dest_emails));
    dest_emails.forEach(function(email) {
        shareFile(fileId, email);
    });
}
$.fn.driveOverlay = function() {
    $(this).append('<div class="drive_overlay"></div>');
    var c = $(this).children('.drive_overlay');
    var rect = $(this)[0].getClientRects()[0];
    alert(JSON.stringify(rect));
    alert(c.length);
    c.css('width', rect.width);
    c.css('height', rect.height);
    c.css('top', rect.top);
    c.css('left', rect.left);
}



</script>

<script src='{% static "js/drive.js" %}'></script>
<script src="http://www.google.com/jsapi"></script>
<script type="text/javascript" src="https://apis.google.com/js/client.js?onload=drive_callback"></script>
<script type="text/javascript" src='{% static "js/moment.js" %}'></script>

{% endblock %}
