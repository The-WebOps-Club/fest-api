{% extends 'base/base.html' %}
{% load check_access %}
{% block content %}
{% load dajaxice_templatetags %}
{% dajaxice_js_import %}
{%  csrf_token %}
{% load staticfiles %}


<script src="//cdn.ckeditor.com/4.4.5/standard/ckeditor.js"></script>

<link rel="stylesheet" type="text/css" href="{% static 'css/jquery.dataTables.css' %}">



<link rel="stylesheet" href="//code.jquery.com/ui/1.11.2/themes/smoothness/jquery-ui.css">
  <script src="//code.jquery.com/jquery-1.10.2.js"></script>
  <script src="//code.jquery.com/ui/1.11.2/jquery-ui.js"></script>
  <link rel="stylesheet" href="/resources/demos/style.css">



<link rel="stylesheet" type="text/css" href="{% static 'css/jquery.datetimepicker.css' %}">
<script type="text/javascript" src="{% static 'js/jquery.datetimepicker.js' %}"></script>

<link rel="stylesheet" type="text/css" href="{% static 'css/select2.css' %}">
<script type="text/javascript" src="{% static 'js/select2.js' %}"></script>


<script>
jQuery(function(){
jQuery("input[name=registration_starts]" ).datetimepicker({format:'m/d/Y H:i'});
jQuery("input[name=registration_ends]" ).datetimepicker({format:'m/d/Y H:i'});
$("select[name=coords]").select2();

CKEDITOR.replace('tab_description_input');
CKEDITOR.replace('edit_taB_description');
});
</script>






{{message}} <br />
<p id="message"> </p> </br>
{% if core_perm %}
<button type="button" onclick="add_new_event();return false;" class="btn primary">Add New Event</button> 
{% endif %}
<button type="button" id="viewid" onclick="Dajaxice.apps.portals.events.view_edit_event(view_edit_event_js);return false;" class="btn  primary">View/Edit Event</button> 
<button type="button" onclick="event_registration_list();return false;" class="btn primary">View Event Registration List</button> 

<br />
<br />
<div id="option_selected">
<h2>VIEW/EDIT EVENTS</h2>
<br />
<br />

</div>   

<div id="event_list">
<table id="tableid">
<thead><tr><th>Event </th> <th> Event Email Id </th></tr></thead>
    {% for event in event_list %}
    <tr> <td>
                <b>{{event.name}}</b>
                {% if core_perm %}
                <button class="btn small danger pull-right" onclick="confirm_delete_event('{{event.name}}')"> X Delete </button>
                &nbsp &nbsp
                {% endif %}
                <button type="button" class="btn btn-xs success pull-right" onclick="Dajaxice.apps.portals.events.show_tabs(show_tabs_js, {'event_name':'{{event.name}}','username':'{{user.username}}'});return false;"><i class="icon-pencil"></i></button></td><td> {{event.email}}</td>
                
        {% endfor %}
</table>
</div>     

<div id="event_name"></div>
<div id="event_tabs"></div>
<br>
<h3 id="selected_event_tab"></h3>
<p><div id="event_tabs_description" class="well"> </div></p>
<br>
<br>

<!--DELETE TAB BUTTON-->
<div id="delete_tab_button"></div> &nbsp

<!--EDIT TAB BUTTON-->
<div id="edit_tab_div"></div>


<!--registration_tab -->
<div id="registration_tab"> </div><br />



<!--ADD NEW TAB FORM -->
<div id="add_new_tab_form" style="display:none;">
<h3> ADD TAB FORM </h3>
<form id="add_tab_form" method="post" action="" >
{%  csrf_token %}
Tab Name: <input type="text" name="tab_name"><br>
Description: <textarea name="tab_description_input" id="add_tab_textarea" rows="20" cols="40" wrap="hard"></textarea>
<input id="add_event_description_hidden" type="hidden" name="tab_description">
<input id="event_name_hidden" type="hidden" name="event_name" value="">
<input type="button" onclick="add_diff_tab_js('{{user.username}}')" value="Create Tab"/>
</form>
</div>

<!--EDIT TAB FORM -->

<div id="edit_tab_form" style="display:none;">
<h3>EDIT TAB FORM</h3>
<form id="edit_form" method="post" action="" >
{%  csrf_token %}
Tab Name: <input type="text" name="tab_Name" id="tab_Name_input" value=""><br>
Description: <textarea id="tab_Description_input" name="edit_taB_description"></textarea>
<input id="tab_description_hidden" type="hidden" name="tab_Description" value="">

<input id="event_Name_edit_form_hidden" type="hidden" name="event_Name_edit_form" value="">
<input id="event_tab_Name_edit_form_hidden" type="hidden" name="event_tab_Name_edit_form" value="">
<input type="button" onclick="edit_tab_intermediate_js('{{user.username}}')" value="Edit Tab" >
</form>
</div>






<!--ADD EVENT FORM -->

<div id="event_form_div" style="display:none;">
<form action="" method="post" id="event_form" accept-charset="utf-8" enctype="multipart/form-data">
{%  csrf_token %}
<table>
{{ event_form.as_table }}
</table>
<p><input type="button" class="btn success" onclick="Dajaxice.apps.portals.events.add_event(add_event_js, {'event_form':$('#event_form').serialize(true)});return false;" value="Add Event"/></p>
</form>
</div>





<!--EDIT EVENT FORM use some inintialize in ajax.py to add initial values and then serialize the form before sending it-->
<div id="edit_event_form_div" style="display:none;">
<h3> EDIT EVENT FORM </h3> All fields left blank will keep the previous values
<form action="" method="post" id="edit_event_form" accept-charset="utf-8" enctype="multipart/form-data">
{%  csrf_token %}
<div id="edit_event_form_dyn"></div>
<p id="edit_event_form_button"></p>
</form>
<br /> <br />
</div>

<!--JS FUNCTIONS -->
<script>

//For the datatable of events list
/*
$(document).ready(function() {
    $('#datatable').dataTable();
} );
*/

function show_tabs_js(data){
    document.getElementById("event_name").innerHTML = "<h2>"+data.event_name+"</h2>";

    document.getElementById("edit_tab_form").style.display="none";
    document.getElementById("add_new_tab_form").style.display = 'none';
    document.getElementById("registration_tab").innerHTML = ' '; 
    document.getElementById("edit_tab_div").innerHTML = ' ';
    document.getElementById("delete_tab_button").innerHTML = ' ';
    document.getElementById("selected_event_tab").innerHTML = ' ';
    document.getElementById("event_tabs_description").innerHTML = ' ';
    document.getElementById("event_list").innerHTML = ' ';
    document.getElementById("option_selected").innerHTML = ' ';
    document.getElementById("edit_event_form_div").style.display = 'none';

    var arr = data.tabs_names_list.split(","); 
    var len = arr.length;
    var text = "",i;
     if (data.has_perm=="yes"){
    text += '<button type="button" class="btn small" onclick="Dajaxice.apps.portals.events.edit_event_details(edit_event_details_js,{\'event_name\':\''+data.event_name+'\'});return false;" >  Edit Event Details &nbsp &nbsp   </button>';
    }
    for (i=0; i < len-1; i++) {
    text += '&nbsp &nbsp<button type="button" class="btn small " onclick="Dajaxice.apps.portals.events.show_tabs_description(show_tabs_description_js, {\'event_name\':\''+data.event_name+'\',\'event_tab\':\''+arr[i]+'\',\'has_perm\':\''+ data.has_perm +'\'});return false;">'+arr[i]+'</button>' + " ";
    }

    //The add_new_tab button is shown only if user has permission
    if (data.has_perm=="yes"){
    text += '<button type="button" class="btn small success pull-right" onclick="add_new_tab_js(\''+data.event_name+'\');return false;"> <i class="icon-plus"></i>Add New Tab </button>' + " ";
    document.getElementById("event_tabs").innerHTML = text;}
    else 
    {
    text+='<br><br><b style="color:red"> You do not have permission to edit this event. Please contact your core if you want to.</b>'
    }
    document.getElementById("event_tabs").innerHTML = text;
    }
    

function show_tabs_description_js(data){
    document.getElementById("selected_event_tab").innerHTML = data.event_tab_name;
	document.getElementById("event_tabs_description").innerHTML =  data.description ;
//delete tab button
	//DELETE and EDIT button displayed only  if user has permission
    if (data.has_perm=="yes"){
    document.getElementById("delete_tab_button").innerHTML = '<button type="button" class="btn small danger" onclick="confirm_delete_tab(\''+data.event_name+'\',\''+data.event_tab_name+'\',\'{{user.username}}\');return false;"> <font size="1">X Delete Tab</font></button>  ';
    
//edit tab button    
    document.getElementById("edit_tab_div").innerHTML = '<button type="button" class="btn small info" onclick="edit_some_tab_js(\''+ data.event_name + '\',\'' + data.event_tab_name + '\',\'' + '#event_tabs_description' + '\')"> Edit Tab Names or Description</button> On clicking this button Form appears at bottom of the page';
    }
    
    //clears add edit tab forms
    document.getElementById("edit_tab_form").style.display='none';
    document.getElementById("add_new_tab_form").style.display = 'none';
    document.getElementById("edit_event_form_div").style.display = 'none';
}

function confirm_delete_tab(event_name,event_tab_name,username){
    if (confirm("Are you sure you want to delete this tab?") == true) {
        Dajaxice.apps.portals.events.delete_tab(delete_tab_js,{'event_name':event_name,'event_tab_name':event_tab_name,'username':username});
    }
}
function add_new_tab_js(event_name){
    document.getElementById("event_name_hidden").value = event_name;
    document.getElementById("add_new_tab_form").style.display="inline";
    document.getElementById("registration_tab").innerHTML = ' '; 
    document.getElementById("edit_tab_div").innerHTML = ' ';
    document.getElementById("delete_tab_button").innerHTML = ' ';
    document.getElementById("selected_event_tab").innerHTML = ' ';
    document.getElementById("event_tabs_description").innerHTML = ' ';
    document.getElementById("edit_event_form_div").style.display = 'none';
    return;
}

function add_diff_tab_js(username){
	var data = CKEDITOR.instances.add_tab_textarea.getData();
	document.getElementById("add_event_description_hidden").value = data;
	Dajaxice.apps.portals.events.add_tab(add_tab_js, {'username':username,'add_tab_form':$('#add_tab_form').serialize(true)});
    return;
}

function delete_tab_js(data){
    toastr.success(data.message);
    document.getElementById("edit_tab_form").style.display='none';
    document.getElementById("add_new_tab_form").style.display = 'none';
    document.getElementById("registration_tab").innerHTML = ' '; 
    document.getElementById("edit_tab_div").innerHTML = ' ';
    document.getElementById("delete_tab_button").innerHTML = ' ';
    document.getElementById("selected_event_tab").innerHTML = ' ';
    document.getElementById("event_tabs_description").innerHTML = ' ';
    document.getElementById("event_list").innerHTML = ' ';
    document.getElementById("option_selected").innerHTML = ' ';
    Dajaxice.apps.portals.events.show_tabs(show_tabs_js,{'event_name':data.event_name,'username':data.username});
}

function edit_some_tab_js(event_name,event_tab_name,target){
	description = $(target).html()
    document.getElementById("event_Name_edit_form_hidden").value = event_name;
    document.getElementById("event_tab_Name_edit_form_hidden").value = event_tab_name;

    document.getElementById("tab_Name_input").value = event_tab_name;
    CKEDITOR.instances.tab_Description_input.setData(description);

    document.getElementById("edit_tab_form").style.display="inline";
    document.getElementById("message").innerHTML="Edit Tab form at the bottom of the page";
    document.getElementById("edit_event_form_div").style.display = 'none';
    
    document.getElementById("add_new_tab_form").style.display = 'none';
    return;
}


function register_js(data){
    alert(data.message);
}


function edit_tab_intermediate_js(username){
	var data = CKEDITOR.instances.tab_Description_input.getData();
	document.getElementById("tab_description_hidden").value = data;
	Dajaxice.apps.portals.events.edit_tab(edit_tab_js, {'username':username,'edit_tab_form':$('#edit_form').serialize(true)});
	}

function edit_tab_js(data){
    var x = document.forms["edit_form"]["tab_Name"].value;
    if (x==null || x=="" || x[0]==" ") {
        toastr.warning("Event Tab Name must be filled. 1st letter cannot be a space");
        return false;
    }
    else{
    toastr.success(data.message);
    document.getElementById("edit_tab_form").style.display='none';
    document.getElementById("add_new_tab_form").style.display = 'none';
    document.getElementById("registration_tab").innerHTML = ' '; 
    document.getElementById("edit_tab_div").innerHTML = ' ';
    document.getElementById("delete_tab_button").innerHTML = ' ';
    document.getElementById("selected_event_tab").innerHTML = ' ';
    document.getElementById("event_tabs_description").innerHTML = ' ';
    document.getElementById("event_list").innerHTML = ' ';
    document.getElementById("option_selected").innerHTML = ' ';
    Dajaxice.apps.portals.events.show_tabs(show_tabs_js,{'event_name':data.event_name,'username':data.username});
    }
}    


function add_tab_js(data){
    var x = document.forms["add_tab_form"]["tab_name"].value;
    if (x==null || x=="" || x[0]==" ") {
        toastr.error("New Event Tab Name must be filled. 1st letter cannot be a space");
    }
    else{
    toastr.success(data.message);
    document.getElementById("edit_tab_form").style.display='none';
    document.getElementById("add_new_tab_form").style.display = 'none';
    document.getElementById("registration_tab").innerHTML = ' '; 
    document.getElementById("edit_tab_div").innerHTML = ' ';
    document.getElementById("delete_tab_button").innerHTML = ' ';
    document.getElementById("selected_event_tab").innerHTML = ' ';
    document.getElementById("event_tabs_description").innerHTML = ' ';
    document.getElementById("event_list").innerHTML = ' ';
    document.getElementById("option_selected").innerHTML = ' ';
    document.getElementById("edit_event_form_div").style.display = 'none';
    Dajaxice.apps.portals.events.show_tabs(show_tabs_js,{'event_name':data.event_name,'username':data.username});
    }
}


//these functions are for the dajaxice at the top of the page.
function view_edit_event_js(data){
	var name,email,i,length,text;
	event_names_array=data.event_names.split("|");
    event_emails_array=data.event_emails.split("|");
    len=event_names_array.length
    text='<table id="tableid"><thead><tr><th>Event </th> <th> Event Email Id </th></tr></thead>';
    for (i=0;i<len-1;i++)
    	{
    	text=text+'<tr><td><b>'+event_names_array[i]+'&nbsp &nbsp</b>{% if core_perm %}<button onclick="confirm_delete_event(\''+event_names_array[i]+'\')" class="btn btn-xs danger pull-right"> X Delete </button> &nbsp &nbsp {% endif %} <button type="button" class="btn btn-xs success pull-right" onclick="Dajaxice.apps.portals.events.show_tabs(show_tabs_js, {\'event_name\':\''+event_names_array[i]+'\',\'username\':\'{{user.username}}\'});return false;"><i class="icon-pencil"></i></button></td><td> '+event_emails_array[i]+'</td></tr>'
    	}
    text=text+'</table>';
    
    document.getElementById("event_list").innerHTML = text
	
    
    document.getElementById("option_selected").innerHTML = '<h2>VIEW/EDIT EVENTS</h2><br><br>';
    
    //make the other stuff disappear
    document.getElementById("event_form_div").style.display = 'none';
    document.getElementById("edit_event_form_div").style.display = 'none';
    $('#tableid').dataTable();
    document.getElementById("event_form_div").style.display = 'none';
    document.getElementById("edit_event_form_div").style.display = 'none';
    document.getElementById("event_name").innerHTML = ' ';
    document.getElementById("event_tabs").innerHTML = ' ';
    document.getElementById("edit_tab_form").style.display='none';
    document.getElementById("add_new_tab_form").style.display = 'none';
    document.getElementById("registration_tab").innerHTML = ' '; 
    document.getElementById("edit_tab_div").innerHTML = ' ';
    document.getElementById("delete_tab_button").innerHTML = ' ';
    document.getElementById("selected_event_tab").innerHTML = ' ';
    document.getElementById("event_tabs_description").innerHTML = ' ';
    
}


function add_new_event(){
   
    document.getElementById("option_selected").innerHTML = '<h2>ADD NEW EVENT</h2>';
    //making data from the other tabs disappear
    document.getElementById("edit_tab_form").style.display='none';
    document.getElementById("add_new_tab_form").style.display = 'none';
    document.getElementById("registration_tab").innerHTML = ' '; 
    document.getElementById("edit_tab_div").innerHTML = ' ';
    document.getElementById("delete_tab_button").innerHTML = ' ';
    document.getElementById("selected_event_tab").innerHTML = ' ';
    document.getElementById("event_tabs_description").innerHTML = ' ';
    document.getElementById("event_list").innerHTML = ' ';
    document.getElementById("edit_event_form_div").style.display = 'none';
        // this set has the additional 2 statements that is not there in most of the other set of commands of this type
    document.getElementById("event_name").innerHTML = ' ';
    document.getElementById("event_tabs").innerHTML = ' ';
    
    //making the add event form visible
    document.getElementById("event_form_div").style.display = 'inline';
}


function event_registration_list(){
    
    document.getElementById("option_selected").innerHTML = '<h2>EVENT REGISTRATION LIST</h3>';
    //making data from the other tabs disappear
    document.getElementById("edit_tab_form").style.display='none';
    document.getElementById("add_new_tab_form").style.display = 'none';
    document.getElementById("registration_tab").innerHTML = ' '; 
    document.getElementById("edit_tab_div").innerHTML = ' ';
    document.getElementById("delete_tab_button").innerHTML = ' ';
    document.getElementById("selected_event_tab").innerHTML = ' ';
    document.getElementById("event_tabs_description").innerHTML = ' ';
    document.getElementById("event_list").innerHTML = '';
    document.getElementById("edit_event_form_div").style.display = 'none';
    // this set has the additional 2 statements that is not there in most of the other set of commands of this type
    document.getElementById("event_name").innerHTML = ' ';
    document.getElementById("event_tabs").innerHTML = ' ';
    
    //make the add_event_form disappear
    document.getElementById("event_form_div").style.display = 'none';
}



function add_event_js(data){
    
    if (data.message[0]=='s')
    {
    toastr.success(data.message);
    document.getElementById("option_selected").innerHTML = '';
    //make the add_event_form disappear
    document.getElementById("event_form_div").style.display = 'none';
    }
    else {
        toastr.warning(data.message);
    }
    
}

function edit_event_js(data){
    if (data.temp){
    document.getElementById("edit_event_form_div").style.display = 'none';
    toastr.success(data.message);
    }
    else {
        toastr.error(data.message);
    }
}



function confirm_delete_event(event_name){
    if (confirm("Are you sure you want to delete this tab?") == true) {
    //alert(event_name);
       Dajaxice.apps.portals.events.delete_event(delete_event_js,{'event_name':event_name});
 
    }
}

function delete_event_js(data){
    alert(data.message);
    Dajaxice.apps.portals.events.view_edit_event(view_edit_event_js);
    }



function edit_event_details_js(data){
    $('#edit_event_form_dyn').html("<table>"+data.form+"</table>");

    document.getElementById("edit_event_form_div").style.display = 'inline';
    document.getElementById("edit_tab_form").style.display='none';
    document.getElementById("add_new_tab_form").style.display = 'none';
    document.getElementById("registration_tab").innerHTML = ' '; 
    document.getElementById("edit_tab_div").innerHTML = ' ';
    document.getElementById("delete_tab_button").innerHTML = ' ';
    document.getElementById("selected_event_tab").innerHTML = ' ';
    document.getElementById("event_tabs_description").innerHTML = ' ';
    document.getElementById("event_list").innerHTML = '';
    

    //Printing the previous values

    document.getElementById("edit_event_form_button").innerHTML = '<input id="edit_event_form_button" type="button" onclick="Dajaxice.apps.portals.events.edit_event(edit_event_js, {\'event_name\':\''+data.event_name+'\',\'edit_event_form\':$(\'#edit_event_form\').serialize(true)});return false;" value="Edit Event"/>';
    
	jQuery("input[name=registration_starts]" ).datetimepicker({format:'m/d/Y H:i'});
	jQuery("input[name=registration_ends]" ).datetimepicker({format:'m/d/Y H:i'});
	$("select[name=coords]").select2();
    }
    
$(document).ready(function(){
$('#tableid').dataTable();
});


</script>

<script type="text/javascript" charset="utf8" src="{% static 'js/jquery-datatables.js' %}"></script>








{% endblock %}





