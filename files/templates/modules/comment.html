{% load staticfiles %} 
{% load humanize %} 
{% load markdown_tags %}
{% load once %}
{% load strip_first_p %}

<div {% if not new_comment %} id="comment_{{ comment.pk }}" {% endif %} class="news_comment {% if new_comment %} create_comment {% endif %}">
    <div class="news_comment_left">
        <img src="" data-id="{% if not new_comment %} {{ comment.by.id }} {% else %} {{ user.id }} {% endif %}" data-fbid="{% if not new_comment %} {{ comment.by.profile.fbid }} {% else %} {{ user_profile.fbid }} {% endif %}" class="news_comment_profile display_pic">
    </div>
    <div class="news_comment_body">
        {% if new_comment %} 
			<div class="row-fluid">
				<form method="POST">
					<div class="span12">
					    {% csrf_token %}
					    <textarea 
					    	class="comment_textarea atwho_at_config resize_textarea span12"
					    	name="comment" 
					    	rows="1" 
					    	data-postid="{{ post.id }}"
					    	placeholder="Post your comment here. *italic*, **bold** etc are allowed."></textarea>
						<div class="span12 comment_links" style="display : none">
							<a href="javascript:void(0)" class="btn small attach_doc_btn" data-placement="below" rel="twipsy" title="Insert a file from google drive">
								<i class="icon-attach"></i>
							</a>
							
							<a href="javascript:void(0)" class="btn small attach_pic_btn" data-placement="below" rel="twipsy" title="Attach a Picture">
								<i class="icon-pic"></i>
							</a>
							
							<a href="javascript:void(0)" class="btn small attach_link_btn" data-placement="below" rel="twipsy" title="Insert a Link">
								<i class="icon-link"></i>
							</a>
							
							<a href="javascript:void(0)" class="btn small attach_emoticon_btn" data-placement="below" rel="twipsy" title="Insert a Smiley">
								<i class="icon-smile"></i>
							</a>

							<a href="javascript:void(0)" class="btn primary post_btn">
								&nbsp;
									<i class="icon-thought"></i>&nbsp; Post
								&nbsp;
							</a>
						</div>
					</div>
				</form>
			</div>
        {% else %}
	        <div class="">
		        <a href="{% url 'profile' comment.by.id %}" class="bold">{{ comment.by.get_full_name }}</a> 
		        <span class="news_comment_info">
		            {% if comment.time_updated == comment.time_created %}
		            	commented {{ comment.time_created|naturaltime }} 
		            {% else %}
		            	edited {{ comment.time_updated|naturaltime }}
		            {% endif %}
		        </span>
	        </div>
	        
	        <div class="comment_text markdown">
		        {% autoescape off %}
		        	{{ comment.description|markdown:"my_default" }} 
		        {% endautoescape %}
	        </div>
	        
       	{% endif %}
    </div>
</div>


{% once comment_styles_and_scripts %}
<style>
	.news_comment {
	    margin-top : 2px;
	    background-color: #EEE;
	    padding : 5px;
	    display : block;
	}
	.news_comment .news_comment_left, .news_comment_profile  
	.news_comment .news_comment_left ,.news_comment .news_comment_left .news_comment_profile {
	    height : 32px;
	    width : 32px;
	    float : left;
	}
	.news_comment .news_comment_body {
	    font-size : 12px;
	    line-height : 15px;
	    margin-left : 40px;
	    min-height : 0px;
	    padding-right : 10px;
	}
	.news_comment .news_comment_body form {
		margin : 0px;
	}
	.news_comment .news_comment_body .news_comment_info {
	    font-size : 11px;
	    line-height : 13px;
	    color : #666;
	    margin-top : 5px;
	}
	.news_comment {

	}
	.resize_textarea {
		-webkit-transition: height 0.2s;
		-moz-transition: height 0.2s;
		transition: height 0.2s;
	}
	.comment_textarea {
		
	}
	.btn.post_btn {
		float: right;
		padding: 3px 5px;
		font-size: 13px;
		float : right;	
	}
/*
    .news_comment_body .comment_text a {
        text-decoration: none;
        border: 1px #AAA solid;
        background-color: #FFF;
        border-radius: 5px;
        padding-right: 3px;
        padding-left: 3px;
        padding-top: 2px;
    }
    .news_comment_body .comment_text img{
        height : 14px;
        width : 14px;
    }
    .news_comment_body .comment_text a:hover {
        background-color:#CCC;
    }*/
</style>

<script>
	function dajax_create_comment(data) {
        $("#post_" + data.post_id + " .news_comment_placeholder").before(data.append_string);

        $("#post_" + data.post_id + " .comment_textarea").removeClass("disabled").prop("disabled", false).removeData("clicked")
        $("#post_" + data.post_id + " .post_btn").removeClass("disabled").prop("disabled", false)

        $("#post_" + data.post_id + " .comment_textarea").val("")
        $("#post_" + data.post_id + " .textarea_atwho_list").remove()
        on_dom_change()
	}

	function attach_doc_callback(data) {

	}
	
	$( document ).ready(function() {
		
		$(".post_btn").click(function() {
			$el_form = $(this).closest("form")
			$el = $el_form.find(".comment_textarea")
			if ( $el.data("clicked") )
				return
        	Dajaxice.apps.walls.create_comment(dajax_create_comment, {
        		'post_id' : $el.data("postid"), 
        		'comment_form': $el.closest("form").serialize(true)
        	});
        	$el.addClass("disabled").prop("disabled", true).data("clicked", "yes")
        	$el_form.find(".post_btn").addClass("disabled").prop("disabled", true)
		})

		$(".comment_textarea")
		.keydown(function(e) {
			e = e || event;
        	el = this; $el = $(this)
        	if (e.ctrlKey && e.keyCode == 13) { // Ctrl+Enter
            	e.preventDefault() // to avoid auto submit of forms
            }
		})
		.keyup(function (e) {
        	e = e || event;
        	el = this; $el = $(this)
            if (e.ctrlKey && e.keyCode == 13) { // Ctrl+Enter
            	$(this).closest("form").find(".post_btn").click()
            	e.preventDefault()
            } 
        })
        .focus( function() {
        	$(this).siblings(".comment_links").show()
        	gapi.load('picker')
        })

        $(".attach_doc_btn").click( function () {
			var all_docsView = new google.picker.DocsView()
	            .setIncludeFolders(true)
	        
	        var my_docsView = new google.picker.DocsView()
	            .setIncludeFolders(true)
				.setSelectFolderEnabled(true)
	            .setOwnedByMe(true)

	        var shared_docsView = new google.picker.DocsView()
	            .setIncludeFolders(true)
	            .setSelectFolderEnabled(true)
	            .setOwnedByMe(false)

	        // var starred_docsView = new google.picker.DocsView()
	        //     .setIncludeFolders(true)
	        //     .setSelectFolderEnabled(true)
	        //     .setStarred(true)

	        var recent_docsView = new google.picker.DocsView(google.picker.ViewId.RECENTLY_PICKED)

	        var uploadView = new google.picker.DocsUploadView()
	            .setIncludeFolders(true)
	        
	        var attach_doc_picker = new google.picker.PickerBuilder()
	            .enableFeature(google.picker.Feature.MULTISELECT_ENABLED)
	            .setOAuthToken(authToken)
	            .addView(all_docsView) // Google Drive
	            .addView(uploadView) // Upload 
	            .addView(recent_docsView) // Prev selected
	            .addView(my_docsView) // My Drive
	            .addView(shared_docsView) // Shared with me
	            //.addView(starred_docsView) // 
	            .setCallback(attach_doc_callback)
	            .build()
				.setVisible(true);
        })

		$(".attach_pic_btn").click( function () {
			var my_picView = new google.picker.View(google.picker.ViewId.DOCS_IMAGES)

			var all_docsView = new google.picker.DocsView()
	            .setIncludeFolders(true)
	        
	        var my_albumView = new google.picker.PhotoAlbumsView()
	        
	        var my_picasaView = new google.picker.PhotosView()

			var upload_picasaView = new google.picker.View(google.picker.ViewId.PHOTO_UPLOAD)

			var search_imageView = new google.picker.ImageSearchView()
			
			var webcamView = new google.picker.WebCamView()

	        var uploadView = new google.picker.DocsUploadView()
	            .setIncludeFolders(true)
	        
	        var attach_doc_picker = new google.picker.PickerBuilder()
	            .enableFeature(google.picker.Feature.MULTISELECT_ENABLED)
	            .setOAuthToken(authToken)
	            .addView(all_docsView)
	            .addView(my_picView)
	            .addView(my_albumView)
	            .addView(my_picasaView)
	            .addView(upload_picasaView)
	            .addView(search_imageView)
	            .addView(webcamView)
	            .addView(uploadView)
	            .setCallback(attach_doc_callback)
	            .build()
				.setVisible(true);
        })
	});
</script>
{% endonce %}