{% load staticfiles %} 
{% load humanize %} 
{% load markdown_tags %}
{% load once %}
{% load strip_first_p %}

<div {% if not new_comment %} id="comment_{{ comment.pk }}" data-id="{{ comment.pk }}" {% endif %} class="news_comment {% if new_comment %} create_comment {% endif %}">
    <div class="news_comment_left">
        <img src="" data-id="{% if not new_comment %} {{ comment.by.id }} {% else %} {{ user.id }} {% endif %}" data-fbid="{% if not new_comment %} {{ comment.by.profile.fbid }} {% else %} {{ user_profile.fbid }} {% endif %}" class="news_comment_profile display_pic">
    </div>
    <div class="news_comment_body">
        {% if new_comment %} 
			<div class="row-fluid">
				<form method="POST">
					<div class="span12">
					    {% csrf_token %}
					    <textarea 
					    	class="comment_textarea atwho_at_config resize_textarea span12"
					    	name="comment" 
					    	rows="1" 
					    	data-postid="{{ post.id }}"
					    	placeholder="Post your comment here. *italic*, **bold** etc are allowed."></textarea>
						<div class="span12 comment_links" style="display : none">
							<a href="javascript:void(0)" class="btn small attach_doc_btn" data-placement="below" rel="twipsy" title="Insert a file from google drive">
								<i class="icon-attach"></i>
							</a>
							
							<a href="javascript:void(0)" class="btn small attach_pic_btn" data-placement="below" rel="twipsy" title="Attach a Picture">
								<i class="icon-pic"></i>
							</a>
							
							<a href="javascript:void(0)" class="btn small attach_link_btn" data-placement="below" rel="twipsy" title="Insert a Link">
								<i class="icon-link"></i>
							</a>
							
							<a href="javascript:void(0)" class="btn small attach_emoticon_btn" data-placement="below" rel="twipsy" title="Insert a Smiley">
								<i class="icon-smile"></i>
							</a>

							<a href="javascript:void(0)" class="btn primary post_btn">
								&nbsp;
									<i class="icon-textbox"></i>&nbsp; Post
								&nbsp;
							</a>
						</div>
					</div>
				</form>
			</div>
        {% else %}
	        <div class="">
		        <a href="{% url 'profile' comment.by.id %}" class="bold">{{ comment.by.get_full_name }}</a> 
		        <span class="news_comment_info">
		            {% if comment.time_updated == comment.time_created %}
		            	commented {{ comment.time_created|naturaltime }} 
		            {% else %}
		            	edited {{ comment.time_updated|naturaltime }}
		            {% endif %}
		        </span>
		        <span style="font-size : 11px" class="comment_small_bar">
        			 · 
        			{% if user in comment.liked_users.all %}
        				Acknowledged
        			{% else %}
        				<a href="javascript:void(0)" class="comment_like_btn">Acknowledge</a>
        			{% endif %}
        			{% if comment.liked_users.count %}
        				 · 
	        			<a class="" href="javascript:void(0)" rel="twipsy" title="{% for u in comment.liked_users.all %}
	        				{{ u.get_full_name }}
	        				{% if not forloop.last %}
	        					{% ifequal forloop.revcounter 2 %} and 
	        					{% else %}, 
	        					{% endifequal %}
	        				{% endif %}
	        			  {% endfor %} acknowledged"
	        			><i class="icon-like"></i> <span class="like_number">{{ comment.liked_users.count }}</span></a>
	        		{% endif %}
        		</span>
	        </div>
	        
	        <div class="comment_text markdown">
		        {% autoescape off %}
		        	{{ comment.description|markdown:"my_default"|default:"<p>&nbsp;</p>" }} 
		        {% endautoescape %}

	        </div>
	        
       	{% endif %}
    </div>
</div>


{% once attach_popovers %}
<div class="hidden insert_link_title">
	<div class="insert_link_title_inner">
		<span class="bold">Insert a link</span>
	</div>
</div>

<div class="hidden insert_link_content">
	<div class="insert_link_content_inner">
		<span class="hidden for_comment"></span>
		Text to display : <br />
		<input class="input1" type="text" name="text" placeholder="Text to display"/><br />
		<br />
		<span class="input2_text">To which URL</span> : <br />
		<input class="input2" type="text" name="link" placeholder="To what URL should this go to ?" /><br />
		<div class="row-fluid">
			<div class="span4">
				<span class="insert_hyper_link">
					<input type="radio" name="type" value="link" class="insert_hyper_link" checked="checked" /> Link
				</span>
			</div>
			<div class="span4">
				<span class="insert_mail_link">
					<input type="radio" name="type" value="mail"  /> Mail
				</span>
			</div>
			<div class="span4">
				<a class="btn primary insert_link_from_popover" href="javascript:void(0)"> 
					OK
				</a>
			</div>
		</div>
	</div>	
</div>

<div class="hidden insert_emoticon_title">
	<div class="insert_emoticon_title_inner">
		<span class="bold">Insert an emoticon</span>
	</div>
</div>

<div class="hidden insert_emoticon_content">
	<div class="insert_emoticon_content_inner">
		<span class="hidden for_comment"></span>
		<div class="emoticon_table">
		</div>
	</div>	
</div>

{% endonce %}

{% once comment_styles_and_scripts %}
<style>
	.news_comment {
	    margin-top : 2px;
	    background-color: #EEE;
	    padding : 5px;
	    display : block;
	}
	.news_comment .news_comment_left, .news_comment_profile  
	.news_comment .news_comment_left ,.news_comment .news_comment_left .news_comment_profile {
	    height : 32px;
	    width : 32px;
	    float : left;
	}
	.news_comment .news_comment_body {
	    font-size : 12px;
	    line-height : 15px;
	    margin-left : 40px;
	    min-height : 0px;
	    padding-right : 10px;
	}
	.news_comment .news_comment_body form {
		margin : 0px;
	}
	.news_comment .news_comment_body .news_comment_info {
	    font-size : 11px;
	    line-height : 13px;
	    color : #666;
	    margin-top : 5px;
	}
	.news_comment {

	}
	.resize_textarea {
		-webkit-transition: height 0.2s;
		-moz-transition: height 0.2s;
		transition: height 0.2s;
	}
	.comment_textarea {
		
	}
	.btn.post_btn {
		float: right;
		padding: 3px 5px;
		font-size: 13px;
		float : right;	
	}
</style>

<script>
	function dajax_create_comment(data) {
        $("#post_" + data.post_id + " .news_comment_placeholder").before(data.append_string);

        $("#post_" + data.post_id + " .comment_textarea").removeClass("disabled").prop("disabled", false).removeData("clicked")
        $("#post_" + data.post_id + " .post_btn").removeClass("disabled").prop("disabled", false).html("&nbsp;<i class='icon-textbox'></i>&nbsp; Post&nbsp;")

        $("#post_" + data.post_id + " .comment_textarea").val("")
        $("#post_" + data.post_id + " .textarea_atwho_list").remove()
        on_dom_change()
	}

	function insert_text(el, text) {
		var $el = $(el), $ip, content;
		if ($el.is('textarea, input')) {
            content = $el.val();
        } else {
            content = $el.text();
        }
        var pos = $el.caret("pos")
        var start_content = content.substr(0, pos)
        var end_content = content.substr($el.caret("pos"), content.length)
        var new_content = start_content + text + end_content
        if ($el.is('textarea, input')) {
            $el.val(new_content);
        } else {
        	$el.text(new_content);
        }
        $el.caret("pos", pos+text.length)
        	.trigger('input.autosize')
	}

	function attach_doc_callback(el, data) {
		$el.closest(".news_comment").find(".attach_doc_btn").removeData("clicked").prop("disabled", false).removeClass("disabled")

		if ( data.action != google.picker.Action.PICKED )
			return

		var $el = $(el).find(".comment_textarea")
		var text = "", file_name = "", file_link = "", file_id = "", file_icon = ""
		for ( var i = 0, d; d = data.docs[i]; i++ ) {
			var clean_name = d.name.replace(/(\(|\)|\[|\]|\"|\")/gi, " ")
			text ='[' + clean_name + '](' + d.iconUrl + ' "doc#' + d.id + '")'
			insert_text($el, text)
		}
	}

	function attach_pic_callback(el, data) {
		$el.closest(".news_comment").find(".attach_pic_btn").removeData("clicked").prop("disabled", false).removeClass("disabled")
		if ( data.action != google.picker.Action.PICKED )
			return

		var $el = $(el).find(".comment_textarea")
		var text = "", file_name = "", file_link = "", file_id = "", file_icon = ""
		for ( var i = 0, d; d = data.docs[i]; i++ ) {
			var clean_name = d.name.replace(/(\(|\)|\[|\]|\"|\")/gi, " ")
			text ='[' + clean_name + '](' + d.iconUrl + ' "doc#' + d.id + '")'
			insert_text($el, text)
		}
	}
	
	$( document ).ready(function() {
		
		$(".post_btn").click(function() {
			$el_form = $(this).closest("form")
			$el = $el_form.find(".comment_textarea")
			if ( $el.data("clicked") || ! $el.val())
				return
        	Dajaxice.apps.walls.create_comment(dajax_create_comment, {
        		'post_id' : $el.data("postid"), 
        		'comment_form': $el.closest("form").serialize(true)	// for content-editability extend the form serializer.
        	});
        	$el.addClass("disabled").prop("disabled", true).data("clicked", "yes")
        	$el_form.find(".post_btn").addClass("disabled").prop("disabled", true).html("&nbsp;<i class='icon-loading-circle icon-rotate'></i>&nbsp; Posting...&nbsp;")
		})

		$(".comment_textarea")
		.keydown(function(e) {
			e = e || event;
        	el = this; $el = $(this)
        	if (e.ctrlKey && e.keyCode == 13) { // Ctrl+Enter
            	e.preventDefault() // to avoid auto submit of forms
            }
		})
		.keyup(function (e) {
        	e = e || event;
        	el = this; $el = $(this)
            if (e.ctrlKey && e.keyCode == 13) { // Ctrl+Enter
            	$(this).closest("form").find(".post_btn").click()
            	e.preventDefault()
            } 
        })
        .focus( function() {
        	$(this).siblings(".comment_links").show()
        	gapi.load('picker')
        }).focusout( function() {
        	$(this).siblings(".comment_links").hide()
        	//gapi.load('picker')
        })

        $(".attach_doc_btn").click( function () {
        	var $el = $(this)
			if ( $el.data("clicked") == "yes" )
				return
			$el.data("clicked", "yes").prop("disabled", true).addClass("disabled")
			
			var all_docsView = new google.picker.DocsView()
	            .setIncludeFolders(true)
	        
	        var my_docsView = new google.picker.DocsView()
	            .setIncludeFolders(true)
				.setSelectFolderEnabled(true)
	            .setOwnedByMe(true)

	        var shared_docsView = new google.picker.DocsView()
	            .setIncludeFolders(true)
	            .setSelectFolderEnabled(true)
	            .setOwnedByMe(false)

	        // var starred_docsView = new google.picker.DocsView()
	        //     .setIncludeFolders(true)
	        //     .setSelectFolderEnabled(true)
	        //     .setStarred(true)

	        var recent_docsView = new google.picker.DocsView(google.picker.ViewId.RECENTLY_PICKED)

	        var uploadView = new google.picker.DocsUploadView()
	            .setIncludeFolders(true)
	        
	        var attach_doc_picker = new google.picker.PickerBuilder()
	            .enableFeature(google.picker.Feature.MULTISELECT_ENABLED)
	            .setOAuthToken(authToken)
	            .addView(all_docsView) // Google Drive
	            .addView(uploadView) // Upload 
	            .addView(recent_docsView) // Prev selected
	            .addView(my_docsView) // My Drive
	            .addView(shared_docsView) // Shared with me
	            //.addView(starred_docsView) // 
	            .setCallback(function(data) { 
	            	var $v = $el.closest(".news_comment"); 
	            	attach_doc_callback($v, data) }
	            )
	            .build()
				.setVisible(true);
        })

		$(".attach_pic_btn").click( function () {

			var $el = $(this)
			if ( $el.data("clicked") == "yes" )
				return
			$el.data("clicked", "yes").prop("disabled", true).addClass("disabled")
			var my_picView = new google.picker.DocsView(google.picker.ViewId.DOCS_IMAGES)
				.setMode(google.picker.DocsViewMode.GRID)

			var all_docsView = new google.picker.DocsView()
	            .setIncludeFolders(true)
	        
	        // var my_albumView = new google.picker.PhotoAlbumsView()
	        
	        // var my_picasaView = new google.picker.PhotosView()	

			// var upload_picasaView = new google.picker.View(google.picker.ViewId.PHOTO_UPLOAD)
			//	.setMode(DocsViewMode.GRID)

			var search_imageView = new google.picker.ImageSearchView()
			
			var webcamView = new google.picker.WebCamView()

	        var uploadView = new google.picker.DocsUploadView()
	            .setIncludeFolders(true)
	        
	        var attach_doc_picker = new google.picker.PickerBuilder()
	            .enableFeature(google.picker.Feature.MULTISELECT_ENABLED)
	            .enableFeature(google.picker.Feature.MULTISELECT_ENABLED)
	            .setOAuthToken(authToken)
	            .addView(my_picView)
	            .addView(uploadView)
	            //.addView(search_imageView)
	            //.addView(webcamView)
	            .addView(all_docsView)
	            .setCallback(function(data) { 
	            	var $v = $el.closest(".news_comment"); 
	            	attach_pic_callback($v, data) }
	            )
	            .build()
				.setVisible(true);
        })

		$(".attach_link_btn").popover({
			"animate": true,
			"delayIn": 200,
			"delayOut": 200,
			"placement": "above",
			"html": true,
			"title": function(e) {
				return $(".insert_link_title.hidden").html()
			},
			"content": function() {
				var $el = $(this)
				$(".insert_link_content.hidden").find(".for_comment").prop("id", $el.closest(".post_container").prop("id"))
				return $(".insert_link_content.hidden").html()
			},
			"trigger": "manual",
			"myClass": "popover_insert_link"
		})
		$(".attach_link_btn").click( function (e) {
			e.stopPropagation();
			hide_popups()
			var $el = $(this)
			$el.popover("show")
			$(".popover_insert_link").click(function(e) {
				e.stopPropagation();
			})
			$(".insert_mail_link").click( function(e) {
				$(this).find("input")[0].checked = true
				var $temp = $(this).closest(".insert_link_content_inner");
			   	$temp.find(".input2").prop("placeholder", "To which email address ?")
			   	$temp.find(".input2_text").text("To which email address")
			})
			$(".insert_hyper_link").click( function(e) {
				$(this).find("input")[0].checked = true
		       	var $temp = $(this).closest(".insert_link_content_inner");
			   	$temp.find(".input2").prop("placeholder", "To what URL should this go to ?")
			  $temp.find(".input2_text").text("To which URL")

			})
			$(".insert_link_from_popover").click( function(e) {
				var $el = $(this).closest(".insert_link_content_inner")
				var $parent = $(".post_container#" + $el.find(".for_comment").prop("id"))
				var text = $el.find(".input1").val()
				var link = $el.find(".input2").val()
				var mail_link = $(".insert_mail_link").find("input").is(":checked")
				if (mail_link) 
					link = "mailto:" + $.trim(link)
				else
					link = $.trim(link)
				insert_text($parent.find(".comment_textarea"), "[" + text + "](" + link + ")")
			})
        })
		
		$(".attach_emoticon_btn").popover({
			"animate": true,
			"delayIn": 200,
			"delayOut": 200,
			"placement": "top",
			"html": true,
			"title": function(e) {
				return $(".insert_emoticon_title.hidden").html()
			},
			"content": function() {
				var $el = $(this)
				$(".insert_emoticon_content.hidden").find(".for_comment").prop("id", $el.closest(".post_container").prop("id"))

				return $(".insert_emoticon_content.hidden").html()
			},
			"trigger": "manual",
			"myClass": "popover_insert_emoticon"
		})
		$(".attach_emoticon_btn").click( function (e) {
			e.stopPropagation();
			hide_popups()
			var $el = $(this)
			$el.popover("show")

			$(".popover_insert_emoticon").click(function(e) {
				e.stopPropagation();
			})
			var $table = $(".popover_insert_emoticon").find(".emoticon_table")
			var emoticon_keys = Object.keys(emoticons)
			for ( var i = 0, name; name = emoticon_keys[i]; i++ ) {
				var symbol = emoticons[name][0]

				var text = "<div style='display : inline-block; cursor : pointer; padding : 4px; border : 1px solid #fff; height : 18px; width : 18px;' class='popover_icon'><i data-symbol='" + symbol +"' class='icon-" + name + "'></i></div>"
				$table.append(text)
			}
			$(".emoticon_table .popover_icon").mouseover( function(e) {
				$(this).css({ "background-color" : "#aaa", "border" : "1px solid #000" })
			})
			.mouseout( function(e) {
				$(this).css({ "background-color" : "#fff", "border" : "1px solid #fff" })
			})
			.click( function(e) {
				var $el = $(this).closest(".insert_emoticon_content_inner")
				$rr = $el
				var $parent = $(".post_container#" + $el.find(".for_comment").prop("id"))
				var text = $.trim($(this).find("i").data("symbol"))
				insert_text($parent.find(".comment_textarea"), " " + text + " ")
			})
        })
		
		$(".comment_like_btn").click(function() {
			var $el = $(this)
			console.log($el.closest(".news_comment")[0])
			Dajaxice.apps.walls.like_comment(function(data) {
				if ( data["msg"] == "error" )
					alert("Acknowledging the comment failed. Please refresh to try again")
			}, {"id" : $el.closest(".news_comment").data("id")})
			$el.closest(".comment_small_bar").find(".like_number").text(parseInt($el.closest(".comment_small_bar").find(".like_number").text()) + 1 + "")
			$el.after("Acknowledged")
			$el.remove()
		})
	});
</script>
{% endonce %}
